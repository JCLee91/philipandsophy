rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // ============================================
    // Storage 보안 규칙 (Firebase Authentication 기반)
    // ============================================
    // 전화번호 인증을 통한 Firebase Auth 사용
    // ============================================

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdminClaim() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isUnder50MB() {
      return request.resource.size < 50 * 1024 * 1024;
    }

    function isUnder10MB() {
      return request.resource.size < 10 * 1024 * 1024;
    }

    // ============================================
    // 독서 인증 이미지 (간소화 - 오류 방지 우선)
    // ============================================
    // 경로: reading_submissions/{participationCode}/{fileName}
    // 로그인한 사용자는 누구나 업로드 가능 (오류 없는 것이 최우선)
    match /reading_submissions/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // ============================================
    // 독서 인증 이미지 (신규 구조 - 레거시 호환용)
    // ============================================
    match /cohorts/{cohortId}/submissions/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // ============================================
    // 공지사항 이미지 (간소화)
    // ============================================
    match /notices/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create, update, delete: if isSignedIn();
    }

    match /cohorts/{cohortId}/notices/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create, update, delete: if isSignedIn();
    }

    // ============================================
    // 다이렉트 메시지 이미지 (간소화)
    // ============================================
    match /direct_messages/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create: if isSignedIn();
      allow update, delete: if false;
    }

    // ============================================
    // 프로필 이미지 (간소화 - 모든 프로필 경로 통합)
    // ============================================
    match /cohorts/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create, update, delete: if isSignedIn();
    }

    match /profiles/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create, update, delete: if isSignedIn();
    }

    match /profileImagesCircle/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create, update, delete: if isSignedIn();
    }

    match /profileImages/{anyPath=**} {
      allow read: if true;  // 공개 읽기
      allow create, update, delete: if isSignedIn();
    }

    match /profile_images/{anyPath=**} {
      allow read: if true;  // 공개 읽기 (1기)
      allow create, update, delete: if isSignedIn();
    }

    // ============================================
    // 기타 경로: 차단
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
