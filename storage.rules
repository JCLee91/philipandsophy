rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // ============================================
    // MVP Storage 보안 규칙
    // ============================================
    // Custom Claims 기반 간결한 규칙
    // 관리자 설정: Firebase Functions에서 request.auth.token.admin = true 설정 필요
    // ============================================

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdminClaim() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isUnder50MB() {
      return request.resource.size < 50 * 1024 * 1024;
    }

    function isUnder10MB() {
      return request.resource.size < 10 * 1024 * 1024;
    }

    // ============================================
    // 독서 인증 이미지
    // ============================================
    match /reading_submissions/{participationCode}/{fileName} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidImage() && isUnder50MB();
      allow update, delete: if false;
    }

    // ============================================
    // 공지사항 이미지
    // ============================================
    match /notices/{cohortId}/{fileName} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && isValidImage() && isUnder10MB();
      allow delete: if isSignedIn();  // UI 레벨에서 관리자만 가능
    }

    // ============================================
    // 다이렉트 메시지 이미지
    // ============================================
    match /direct_messages/{userId}/{fileName} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && isValidImage() && isUnder50MB();
      allow update, delete: if false;
    }

    // ============================================
    // 프로필 이미지
    // ============================================
    match /profiles/{userId}/{fileName} {
      allow read: if isSignedIn();
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    // ============================================
    // 프로필 이미지 (원형) - 공개 읽기
    // ============================================
    match /profileImagesCircle/{fileName} {
      allow read: if true;  // 공개 읽기 허용
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    // ============================================
    // 프로필 카드 이미지 - 공개 읽기
    // ============================================
    match /profileImages/{fileName} {
      allow read: if true;  // 공개 읽기 허용
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    // ============================================
    // 기타 경로: 차단
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
