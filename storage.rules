rules_version = '2';

service firebase.storage {
  match /b/{bucket}/o {
    // ============================================
    // Storage 보안 규칙 (Firebase Authentication 기반)
    // ============================================
    // 전화번호 인증을 통한 Firebase Auth 사용
    // ============================================

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdminClaim() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    function isValidImage() {
      return request.resource.contentType.matches('image/.*');
    }

    function isUnder50MB() {
      return request.resource.size < 50 * 1024 * 1024;
    }

    function isUnder10MB() {
      return request.resource.size < 10 * 1024 * 1024;
    }

    // ============================================
    // 독서 인증 이미지 (신규 구조)
    // ============================================
    match /cohorts/{cohortId}/submissions/{participationCode}/{fileName} {
      allow read: if true;  // 공개 읽기 (프로필북에서 표시)
      allow create: if isSignedIn() && isValidImage() && isUnder50MB();
      allow update, delete: if false;
    }

    // ============================================
    // 독서 인증 이미지 (구버전 - 하위 호환)
    // ============================================
    match /reading_submissions/{participationCode}/{fileName} {
      allow read: if true;  // 공개 읽기로 변경
      allow create: if isSignedIn() && isValidImage() && isUnder50MB();
      allow update, delete: if false;
    }

    // ============================================
    // 공지사항 이미지 - 공개 읽기
    // ============================================
    match /notices/{cohortId}/{fileName} {
      allow read: if true;  // 공개 읽기 허용 (공지사항은 모든 사용자에게 표시)
      allow create, update: if isSignedIn() && isValidImage() && isUnder10MB();
      allow delete: if isSignedIn();  // UI 레벨에서 관리자만 가능
    }

    // ============================================
    // 다이렉트 메시지 이미지
    // ============================================
    match /direct_messages/{userId}/{fileName} {
      allow read: if true;  // 공개 읽기
      allow create: if isSignedIn() && isValidImage() && isUnder50MB();
      allow update, delete: if false;
    }

    // ============================================
    // 프로필 이미지 (신규 구조)
    // ============================================
    match /cohorts/{cohortId}/profiles/{fileName} {
      allow read: if true;  // 공개 읽기
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    // ============================================
    // 프로필 이미지 (구버전 - 하위 호환)
    // ============================================
    match /profiles/{userId}/{fileName} {
      allow read: if true;  // 공개 읽기
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    match /profileImagesCircle/{fileName} {
      allow read: if true;  // 공개 읽기
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    match /profileImages/{fileName} {
      allow read: if true;  // 공개 읽기
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    match /profile_images/{fileName} {
      allow read: if true;  // 공개 읽기 (1기)
      allow create, update: if isSignedIn() && isValidImage() && isUnder50MB();
      allow delete: if isSignedIn();
    }

    // ============================================
    // 기타 경로: 차단
    // ============================================
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
