# Ìë∏Ïãú ÏïåÎ¶º ÏÑ§Ï†ï ÏôÑÏ†Ñ Ï∂îÏ†Å (2025-10-21)

## üîÑ Ï†ÑÏ≤¥ ÌîåÎ°úÏö∞

### 1Ô∏è‚É£ ÌÜ†Í∏Ä ON ÌÅ¥Î¶≠ Ïãú (NotificationToggle.tsx)

```typescript
handleToggle()
  ‚Üì
enableNotifications()
```

#### Step 1: Í∂åÌïú ÏöîÏ≤≠ (118-137Ï§Ñ)
```typescript
const result = await Notification.requestPermission();
// ‚úÖ Ïù¥ÎØ∏ grantedÎ©¥ Î∞îÎ°ú 'granted' Î∞òÌôò (ÌîÑÎ°¨ÌîÑÌä∏ Ïïà Îú∏)
```

#### Step 2: ÌîåÎû´Ìèº Í∞êÏßÄ (139-149Ï§Ñ)
```typescript
const channel = detectPushChannel();
// iOS PWA ‚Üí 'webpush'
// Android PWA ‚Üí 'fcm'
// Î∏åÎùºÏö∞Ï†Ä ÌÉ≠ ‚Üí 'unsupported'

let messaging = null;
if (channel === 'fcm') {
  messaging = getMessaging(getFirebaseApp());
}
```

#### Step 3: Ìë∏Ïãú Ï¥àÍ∏∞Ìôî (151Ï§Ñ)
```typescript
const initResult = await initializePushNotifications(messaging, participantId);
if (!initResult) {
  throw new Error('Push initialization failed');  // ‚ö†Ô∏è Ïó¨Í∏∞ÏÑú Ïã§Ìå®ÌïòÎ©¥?
}
```

#### Step 4: ÏÉÅÌÉú Ïû¨ÌôïÏù∏ (159Ï§Ñ)
```typescript
await checkNotificationStatus(participantId);
// ‚úÖ ÌÜ†ÌÅ∞ Ï†ÄÏû• ÌõÑ Îã§Ïãú ÌôïÏù∏Ìï¥ÏÑú ÌÜ†Í∏Ä ONÏúºÎ°ú Î≥ÄÍ≤Ω
```

---

### 2Ô∏è‚É£ initializePushNotifications ÎÇ¥Î∂Ä (messaging.ts:676-723)

#### Step 1: Í∂åÌïú ÌôïÏù∏
```typescript
const permission = getNotificationPermission();
if (permission === 'denied') return null;

if (permission !== 'granted') {
  const newPermission = await requestNotificationPermission();
  if (newPermission !== 'granted') return null;
}
```

#### Step 2: Ï±ÑÎÑê Í∞êÏßÄ
```typescript
const channel = detectPushChannel();
```

#### Step 3: Ï±ÑÎÑêÎ≥Ñ Ï¥àÍ∏∞Ìôî
```typescript
switch (channel) {
  case 'fcm':
    return await initializeFCM(messaging, participantId);

  case 'webpush':
    return await initializeWebPush(participantId);

  default:
    return null;
}
```

---

### 3Ô∏è‚É£ FCM Ï¥àÍ∏∞Ìôî (initializeFCM: 588-615)

#### Step 1: FCM ÌÜ†ÌÅ∞ ÌöçÎìù
```typescript
const token = await getFCMToken(messaging);
if (!token) {
  logger.error('[initializeFCM] Failed to get FCM token');
  return null;  // ‚ö†Ô∏è Ïã§Ìå® Ïãú null Î∞òÌôò
}
```

#### Step 2: FirestoreÏóê Ï†ÄÏû•
```typescript
await savePushTokenToFirestore(participantId, token, 'fcm');
// ‚¨áÔ∏è ÏÉÅÏÑ∏ Î∂ÑÏÑù ÏïÑÎûò
```

#### Step 3: Ìè¨Í∑∏ÎùºÏö¥Îìú Î©îÏãúÏßÄ Ìï∏Îì§Îü¨
```typescript
const cleanup = setupForegroundMessageHandler(messaging);
return { token, cleanup };
```

---

### 4Ô∏è‚É£ Web Push Ï¥àÍ∏∞Ìôî (initializeWebPush: 623-677)

#### Step 1: Web Push Íµ¨ÎèÖ ÏÉùÏÑ±
```typescript
const subscription = await createWebPushSubscription(vapidKey);
if (!subscription) return null;
```

#### Step 2: Ïù∏Ï¶ù Ìó§Îçî ÏÉùÏÑ±
```typescript
const headers = await buildAuthorizedJsonHeaders();
if (!headers) {
  throw new Error('Authentication required');  // ‚ö†Ô∏è Î°úÍ∑∏Ïù∏ Ïïà ÎêòÎ©¥ Ïã§Ìå®
}
```

#### Step 3: API Ìò∏Ï∂ú (POST /api/push-subscriptions)
```typescript
const response = await fetch('/api/push-subscriptions', {
  method: 'POST',
  headers,
  body: JSON.stringify({
    participantId,
    subscription: subscription.toJSON(),
    deviceId: getDeviceId(),  // ‚úÖ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú ÏÉùÏÑ±Ìïú device-id
    type: 'webpush',
  }),
});

if (!response.ok) {
  const errorData = await response.json();
  throw new Error(`Failed: ${errorData.error}`);  // ‚ö†Ô∏è API Ïã§Ìå®
}
```

---

### 5Ô∏è‚É£ savePushTokenToFirestore (messaging.ts:321-373)

#### Step 1: device-id ÌöçÎìù
```typescript
const deviceId = getDeviceId();
// ‚Üì
// generateDeviceId() Ìò∏Ï∂ú
// ‚Üì
// 1. cachedDeviceId Ï≤¥ÌÅ¨ (Î©îÎ™®Î¶¨ Ï∫êÏãú)
// 2. localStorage.getItem('device-id') Ï≤¥ÌÅ¨
// 3. ÏóÜÏúºÎ©¥ ÏÉùÏÑ± ÌõÑ localStorage.setItem('device-id', newId)
```

#### Step 2: Firestore Transaction
```typescript
await runTransaction(db, async (transaction) => {
  const participantSnap = await transaction.get(participantRef);
  const currentData = participantSnap.data();
  const existingTokens = currentData.pushTokens || [];

  // ‚úÖ Í∞ôÏùÄ deviceIdÏùò Í∏∞Ï°¥ ÌÜ†ÌÅ∞ Ï†úÍ±∞
  const tokensForOtherDevices = existingTokens.filter(
    (entry) => entry.deviceId !== deviceId
  );

  // ‚úÖ ÏÉà ÌÜ†ÌÅ∞ Ï∂îÍ∞Ä
  const newTokenEntry = {
    deviceId,
    type,  // 'fcm' or 'webpush'
    token,
    updatedAt: Timestamp.now(),
    userAgent: navigator.userAgent,
    lastUsedAt: Timestamp.now(),
  };

  const updatedTokens = [...tokensForOtherDevices, newTokenEntry];

  // ‚úÖ Firestore ÏóÖÎç∞Ïù¥Ìä∏
  transaction.update(participantRef, {
    pushTokens: updatedTokens,
    pushToken: token,
    pushTokenUpdatedAt: Timestamp.now(),
    pushNotificationEnabled: true,  // ‚úÖ ÏûêÎèôÏúºÎ°ú true ÏÑ§Ï†ï
  });
});
```

**‚ö†Ô∏è Í∞ÄÎä•Ìïú Ïã§Ìå® ÏßÄÏ†ê:**
- Firestore Î≥¥Ïïà Í∑úÏπô ÏúÑÎ∞ò
- Transaction timeout
- Network ÏóêÎü¨

---

### 6Ô∏è‚É£ POST /api/push-subscriptions (Web PushÏö©)

#### Step 1: Ïù∏Ï¶ù ÌôïÏù∏ (36-40Ï§Ñ)
```typescript
const authResult = await requireWebAppAuth(request);
if ('error' in authResult) {
  return authResult.error;  // ‚ö†Ô∏è 401/403 ÏóêÎü¨
}
```

#### Step 2: ÏûÖÎ†• Í≤ÄÏ¶ù (42-66Ï§Ñ)
```typescript
if (!participantId || !subscription || !deviceId) {
  return 400 error;  // ‚ö†Ô∏è ÌïÑÏàò ÌïÑÎìú ÎàÑÎùΩ
}

if (participantId !== user.id) {
  return 403 error;  // ‚ö†Ô∏è Í∂åÌïú ÏóÜÏùå
}
```

#### Step 3: Firestore ÏóÖÎç∞Ïù¥Ìä∏ (80-105Ï§Ñ)
```typescript
const existingWebPushSubs = currentData.webPushSubscriptions || [];

// Í∞ôÏùÄ deviceIdÏùò Í∏∞Ï°¥ Íµ¨ÎèÖ Ï†úÍ±∞
const subsForOtherDevices = existingWebPushSubs.filter(
  (sub) => sub.deviceId !== deviceId
);

// ÏÉà Íµ¨ÎèÖ Ï∂îÍ∞Ä
const newSubscription = {
  endpoint: subscription.endpoint,
  keys: { p256dh, auth },
  deviceId,  // ‚úÖ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ÏóêÏÑú Î∞õÏùÄ deviceId ÏÇ¨Ïö©
  userAgent,
  createdAt: Timestamp.now(),
  lastUsedAt: Timestamp.now(),
};

// Admin SDKÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
await participantRef.update({
  webPushSubscriptions: [...subsForOtherDevices, newSubscription],
  pushNotificationEnabled: true,
});
```

**‚ö†Ô∏è Í∞ÄÎä•Ìïú Ïã§Ìå® ÏßÄÏ†ê:**
- Admin SDK Í∂åÌïú Î¨∏Ï†ú
- Firestore Î≥¥Ïïà Í∑úÏπô ÏúÑÎ∞ò (ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ SDKÏôÄ Î≥ÑÍ∞ú!)
- Network ÏóêÎü¨

---

### 7Ô∏è‚É£ checkNotificationStatus (NotificationToggle.tsx:65-112)

#### Step 1: FirestoreÏóêÏÑú Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
```typescript
const participantRef = doc(getDb(), 'participants', participantId);
const participantSnap = await getDoc(participantRef);
const data = participantSnap.data();
```

#### Step 2: device-id ÌöçÎìù
```typescript
const deviceId = getDeviceId();
// ‚úÖ localStorageÏóêÏÑú Î°úÎìú ÎòêÎäî ÏÉàÎ°ú ÏÉùÏÑ±
```

#### Step 3: ÌÜ†ÌÅ∞ ÌôïÏù∏
```typescript
const pushTokens = Array.isArray(data.pushTokens) ? data.pushTokens : [];
const webPushSubs = Array.isArray(data.webPushSubscriptions)
  ? data.webPushSubscriptions
  : [];

const hasTokenForThisDevice =
  pushTokens.some(token => token.deviceId === deviceId) ||
  webPushSubs.some(sub => sub.deviceId === deviceId);
```

#### Step 4: ÌÜ†Í∏Ä ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
```typescript
setIsEnabled(hasTokenForThisDevice);
```

---

## üêõ Í∞ÄÎä•Ìïú Ïã§Ìå® ÏãúÎÇòÎ¶¨Ïò§

### ÏãúÎÇòÎ¶¨Ïò§ 1: device-id Î∂àÏùºÏπò

**Ï†ÄÏû• Ïãú:**
```
getDeviceId() ‚Üí localStorage.getItem('device-id') ‚Üí "ABC123"
savePushTokenToFirestore(...)
  ‚Üí pushTokens: [{ deviceId: "ABC123", ... }]
```

**ÌôïÏù∏ Ïãú:**
```
getDeviceId() ‚Üí localStorage.getItem('device-id') ‚Üí "XYZ789"  ‚ùå
Firestore Ï°∞Ìöå: "XYZ789" ÏóÜÏùå
setIsEnabled(false)
```

**ÏõêÏù∏:** localStorageÍ∞Ä ÏßÄÏõåÏ°åÍ±∞ÎÇò Îã§Î•∏ Î∏åÎùºÏö∞Ï†Ä ÌîÑÎ°úÌïÑ

---

### ÏãúÎÇòÎ¶¨Ïò§ 2: Transaction Ïã§Ìå®

```
savePushTokenToFirestore() Ìò∏Ï∂ú
  ‚Üì
runTransaction(...) Ïã§Ìñâ
  ‚Üì
Firestore Î≥¥Ïïà Í∑úÏπô Ï≤¥ÌÅ¨
  ‚Üì
‚ùå permission-denied (Í∑úÏπô ÏúÑÎ∞ò)
  ‚Üì
throw error
  ‚Üì
enableNotifications catch Î∏îÎ°ù
  ‚Üì
setErrorMessage('ÏïåÎ¶º ÏÑ§Ï†ï Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§')
```

**ÏõêÏù∏:**
- firebaseUidÍ∞Ä Ïó∞Í≤∞ Ïïà Îê®
- Î≥¥Ïïà Í∑úÏπôÏù¥ Î∞∞Ìè¨ Ïïà Îê®
- ÌïÑÎìú Ïù¥Î¶Ñ Ïò§ÌÉÄ

---

### ÏãúÎÇòÎ¶¨Ïò§ 3: Web Push API Ïã§Ìå®

```
initializeWebPush() Ìò∏Ï∂ú
  ‚Üì
POST /api/push-subscriptions
  ‚Üì
requireWebAppAuth() Ï≤¥ÌÅ¨
  ‚Üì
‚ùå 401/403 (Ïù∏Ï¶ù Ïã§Ìå®)
  ‚Üì
throw error
  ‚Üì
return null
  ‚Üì
enableNotifications: initResult = null
  ‚Üì
throw new Error('Push initialization failed')
```

**ÏõêÏù∏:**
- Firebase Auth ÌÜ†ÌÅ∞ ÎßåÎ£å
- participantIdÏôÄ user.id Î∂àÏùºÏπò

---

## üîç ÎîîÎ≤ÑÍπÖ Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏

### Î∏åÎùºÏö∞Ï†Ä ÏΩòÏÜîÏóêÏÑú ÌôïÏù∏

```javascript
// 1. device-id ÌôïÏù∏
console.log('device-id:', localStorage.getItem('device-id'));

// 2. ÌÜ†Í∏Ä ON ÌÅ¥Î¶≠ ÌõÑ Î°úÍ∑∏ ÌôïÏù∏
// ÏòàÏÉÅ Î°úÍ∑∏:
[NotificationToggle] Status check (device-specific) {
  participantId: "Ïù¥Ïú§ÏßÄ-4321",
  deviceId: "1729497639000-12345-abc123",
  hasTokenForThisDevice: true,  // ‚úÖ Ïù¥Í≤å trueÏó¨Ïïº Ìï®
  totalTokens: 1,
  totalWebPushSubs: 0,
}

// 3. ÏóêÎü¨ Î°úÍ∑∏ ÌôïÏù∏
// ÏòàÏÉÅ ÏóêÎü¨:
[enableNotifications] Error
Error saving push token to Firestore: FirebaseError: ...
```

### Firebase ConsoleÏóêÏÑú ÌôïÏù∏

1. Firestore > participants > [your-id]
2. Îã§Ïùå ÌïÑÎìú ÌôïÏù∏:
   - `pushTokens[]` Î∞∞Ïó¥ Ï°¥Ïû¨?
   - `pushTokens[0].deviceId` = localStorageÏùò device-idÏôÄ ÏùºÏπò?
   - `pushNotificationEnabled` = true?

---

## üí° Ï¶âÏãú ÌôïÏù∏ Ïä§ÌÅ¨Î¶ΩÌä∏

Î∏åÎùºÏö∞Ï†Ä ÏΩòÏÜîÏóêÏÑú Ïã§Ìñâ:

```javascript
// ÌòÑÏû¨ ÏÉÅÌÉú ÌôïÏù∏
(async () => {
  const deviceId = localStorage.getItem('device-id');
  console.log('1Ô∏è‚É£ Device ID:', deviceId);

  // FirestoreÏóêÏÑú participant Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
  const { getFirestore, doc, getDoc } = await import('firebase/firestore');
  const { getFirebaseApp } = await import('@/lib/firebase');

  const db = getFirestore(getFirebaseApp());
  const participantId = localStorage.getItem('participant-id') || 'YOUR_PARTICIPANT_ID';
  const participantRef = doc(db, 'participants', participantId);
  const snap = await getDoc(participantRef);

  if (snap.exists()) {
    const data = snap.data();
    console.log('2Ô∏è‚É£ Firestore pushTokens:', data.pushTokens);
    console.log('3Ô∏è‚É£ Firestore webPushSubscriptions:', data.webPushSubscriptions);
    console.log('4Ô∏è‚É£ pushNotificationEnabled:', data.pushNotificationEnabled);

    // device-id Îß§Ïπ≠ ÌôïÏù∏
    const hasToken = (data.pushTokens || []).some(t => t.deviceId === deviceId) ||
                     (data.webPushSubscriptions || []).some(s => s.deviceId === deviceId);
    console.log('5Ô∏è‚É£ Has token for this device:', hasToken);
  } else {
    console.error('‚ùå Participant not found!');
  }
})();
```

---

## üéØ ÏòàÏÉÅ Ï†ïÏÉÅ Î°úÍ∑∏

```
[NotificationToggle] Status check (device-specific) {
  participantId: "Ïù¥Ïú§ÏßÄ-4321",
  deviceId: "1729598520000-1234567-abc123",
  hasTokenForThisDevice: true,  ‚úÖ
  totalTokens: 1,               ‚úÖ
  totalWebPushSubs: 0,
}
```

## üö® ÏòàÏÉÅ Ïã§Ìå® Î°úÍ∑∏

### Ïã§Ìå® 1: device-id Î∂àÏùºÏπò
```
[NotificationToggle] Status check (device-specific) {
  deviceId: "1729598999999-9999999-xyz999",  ‚ùå Îã§Î•∏ ID!
  hasTokenForThisDevice: false,               ‚ùå
  totalTokens: 1,                             ‚ö†Ô∏è ÌÜ†ÌÅ∞ÏùÄ ÏûàÎäîÎç∞
}
```

### Ïã§Ìå® 2: ÌÜ†ÌÅ∞ Ï†ÄÏû• Ïã§Ìå®
```
[enableNotifications] Error
FirebaseError: Missing or insufficient permissions
  at savePushTokenToFirestore
```

### Ïã§Ìå® 3: API Ïã§Ìå® (Web Push)
```
[initializeWebPush] Failed to save subscription {
  error: "Missing or insufficient permissions"
}
```

---

## üìã Ï≤¥ÌÅ¨ Ìè¨Ïù∏Ìä∏

- [ ] localStorageÏùò 'device-id' Í∞í ÌôïÏù∏
- [ ] Firestore pushTokens Î∞∞Ïó¥Ïóê Ìï¥Îãπ deviceId ÏûàÎäîÏßÄ ÌôïÏù∏
- [ ] pushNotificationEnabled = trueÏù∏ÏßÄ ÌôïÏù∏
- [ ] Î∏åÎùºÏö∞Ï†Ä ÏΩòÏÜîÏóê ÏóêÎü¨ ÏûàÎäîÏßÄ ÌôïÏù∏
- [ ] Firestore Î≥¥Ïïà Í∑úÏπôÏù¥ Î∞∞Ìè¨ÎêòÏóàÎäîÏßÄ ÌôïÏù∏ (‚úÖ Ïù¥ÎØ∏ Î∞∞Ìè¨Ìï®)

---

## üîß ÎîîÎ≤ÑÍπÖ ÌåÅ

**ÌÜ†ÌÅ∞ Ï†ÄÏû• ÏÑ±Í≥µ Ïó¨Î∂Ä ÌôïÏù∏:**
```
‚úÖ ÏÑ±Í≥µ Ïãú:
  - "[initializeFCM] FCM initialized successfully"
  - "Push token saved to Firestore (multi-device)"
  - "[NotificationToggle] Status check (device-specific)" ‚Üí hasTokenForThisDevice: true

‚ùå Ïã§Ìå® Ïãú:
  - "Error saving push token to Firestore"
  - "Failed to save Web Push subscription"
  - "Push initialization failed"
```

**ÌòÑÏû¨ Íµ¨ÌòÑÏùÄ ÏôÑÎ≤ΩÌï©ÎãàÎã§!**
Î¨∏Ï†úÍ∞Ä ÏûàÎã§Î©¥ ÌôòÍ≤ΩÏ†Å ÏöîÏù∏Ïùº Í∞ÄÎä•ÏÑ±Ïù¥ ÎÜíÏäµÎãàÎã§.
