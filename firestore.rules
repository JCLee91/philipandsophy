rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // 필립앤소피 Firestore 보안 규칙
    // ============================================
    // 정책: 오류 없는 것이 최우선 (보안 < 안정성)
    // UI 레벨에서 권한 제어, Rules는 최소한만 체크
    // Last Updated: 2025-11-09 22:30
    // ============================================

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    // 관리자 확인
    function isAdminClaim() {
      return isSignedIn() && request.auth.token.admin == true;
    }

    // 현재 사용자가 관리자 Participant인지 확인
    function isAdminParticipant() {
      // firebaseUid로 participant 찾기 (모든 participants 순회)
      return isSignedIn() &&
             exists(/databases/$(database)/documents/participants/admin) &&
             get(/databases/$(database)/documents/participants/admin).data.firebaseUid == request.auth.uid &&
             get(/databases/$(database)/documents/participants/admin).data.isAdministrator == true;
    }

    // pushTokens 배열 항목 검증
    function isValidPushTokens(tokens) {
      return tokens is list &&
             tokens.size() <= 20;
    }

    function isValidWebPushSubscriptions(subscriptions) {
      return subscriptions is list &&
             subscriptions.size() <= 20;
    }

    // ============================================
    // 기수 정보 (Cohorts)
    // ============================================
    match /cohorts/{cohortId} {
      allow read: if true;              // 공개 읽기 허용
      allow write: if isAdminClaim();   // 관리자만 쓰기

      // Daily Questions 서브컬렉션
      match /daily_questions/{questionId} {
        allow read: if isSignedIn();    // 로그인한 사용자는 읽기 가능
        allow write: if isAdminClaim(); // 관리자만 쓰기 가능
      }
    }

    // ============================================
    // 참가자 정보 (Participants)
    // ============================================
    match /participants/{participantId} {
      allow read: if isSignedIn();
      allow create: if false;           // 시스템에서만 생성

      // 업데이트: 3가지 케이스 허용
      // 1) 최초 firebaseUid 연결 (null → auth.uid)
      // 2) firebaseUid 재연결 (기존 UID → 새 UID, 같은 전화번호)
      // 3) 기존 소유자만 허용 필드 변경
      allow update: if isSignedIn() && (
        // 케이스 1+2: 로그인한 사용자가 자신의 UID로 연결 (firebaseUid가 null이거나 다를 수 있음)
        (request.resource.data.firebaseUid == request.auth.uid &&
         request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['firebaseUid', 'updatedAt'])) ||

        // 케이스 3: 기존 소유자의 프로필 업데이트
        (
          resource.data.firebaseUid == request.auth.uid &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['name', 'profileImage', 'profileImageCircle', 'profileBookUrl',
                     'occupation', 'bio', 'currentBookTitle', 'currentBookAuthor',
                     'currentBookCoverUrl', 'bookHistory', 'pushToken', 'pushTokenUpdatedAt',
                     'pushNotificationEnabled', 'lastActivityAt', 'pushTokens', 'webPushSubscriptions', 'updatedAt']) &&
          (!request.resource.data.keys().hasAny(['pushTokens']) ||
            isValidPushTokens(request.resource.data.pushTokens)) &&
          (!request.resource.data.keys().hasAny(['webPushSubscriptions']) ||
            isValidWebPushSubscriptions(request.resource.data.webPushSubscriptions))
        )
      );

      allow delete: if false;
    }

    // ============================================
    // 공지사항 (Notices)
    // ============================================
    match /notices/{noticeId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();   // UI 레벨에서 관리자만 버튼 표시
    }

    // ============================================
    // 다이렉트 메시지 (Messages)
    // ============================================
    match /messages/{messageId} {
      // 읽기: 로그인한 모든 사용자 허용
      //
      // 이전 규칙 (isOwnParticipant 사용)의 문제점:
      // - get() 호출로 인한 추가 Firestore 읽기 비용 (메시지 1개당 6회 읽기)
      // - Security Rules 복잡도 증가로 인한 400 에러 발생
      // - 실시간 리스너(onSnapshot) 차단 문제
      //
      // 현재 규칙:
      // - UI 레벨에서 권한 제어 (DirectMessageDialog는 otherUser 체크)
      // - 단순 로그인 검증으로 성능 및 안정성 개선
      // - 소규모 프로젝트에서는 이 정도 보안으로 충분
      allow read: if isSignedIn();

      // 생성: 로그인 + 필수 필드만 체크 (isOwnParticipant 제거)
      allow create: if isSignedIn() &&
        request.resource.data.senderId is string &&
        request.resource.data.receiverId is string &&
        request.resource.data.conversationId is string &&
        ((request.resource.data.content is string && request.resource.data.content.size() > 0) ||
         (request.resource.data.imageUrl is string && request.resource.data.imageUrl.size() > 0));

      // 수정: isRead 필드만 변경 가능 (로그인한 사용자)
      // 이전 규칙의 isOwnParticipant() 제거 (read 규칙과 동일한 이유)
      allow update: if isSignedIn() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);

      allow delete: if false;
    }

    // ============================================
    // 독서 인증 자료 (Reading Submissions)
    // ============================================
    // 느슨한 규칙: 로그인한 사용자는 자유롭게 생성/수정/삭제 가능
    // (오류 없는 것이 최우선, UI 레벨에서 권한 제어)
    match /reading_submissions/{submissionId} {
      allow read: if isSignedIn();

      // 생성: 로그인 + 필수 필드만 체크
      allow create: if isSignedIn() &&
        request.resource.data.participantId is string &&
        request.resource.data.participationCode is string &&
        request.resource.data.status in ['draft', 'pending', 'approved', 'rejected'];

      // 수정/삭제: 로그인만 체크 (isOwnParticipant 제거)
      allow update, delete: if isSignedIn();
    }

    // ============================================
    // 매칭 프리뷰 (Matching Previews)
    // ============================================
    match /matching_previews/{previewId} {
      allow read: if isSignedIn();     // 로그인한 사용자는 읽기 가능
      allow write: if isAdminClaim();  // 관리자만 쓰기 가능
    }

    // ============================================
    // 매칭 결과 (Matching Results)
    // ============================================
    match /matching_results/{resultId} {
      allow read: if isSignedIn();     // 로그인한 사용자는 읽기 가능
      allow write: if true;            // 스케줄러가 쓸 수 있도록 완전 개방
    }

    // ============================================
    // 사용자 메타데이터 (Users) - 향후 구현용
    // ============================================
    match /users/{userId} {
      allow read: if isSignedIn() && request.auth.uid == userId;
      allow create, update, delete: if false;
    }
  }
}
