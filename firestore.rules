rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // ============================================
    // 프로덕션 모드 - 보안 규칙 적용
    // ============================================
    // Firebase Phone Authentication 기반 보안 규칙
    // 2025-10-16 업데이트: 인증 기반 접근 제어 강화
    // ============================================

    // Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/participants/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/participants/$(request.auth.uid)).data.isAdministrator == true;
    }

    // ============================================
    // 기수 정보 (Cohorts)
    // ============================================
    match /cohorts/{cohortId} {
      // 읽기: 모두 허용 (로그인 전 접근 코드 검증용)
      allow read: if true;

      // 쓰기: 관리자만 허용
      allow create, update: if isAdmin();
      allow delete: if false; // 삭제 금지
    }

    // ============================================
    // 참가자 정보 (Participants)
    // ============================================
    match /participants/{participantId} {
      // 읽기: 로그인한 사용자만 (채팅방 참가자 목록)
      allow read: if isSignedIn();

      // 생성: Firebase 시스템에서만 (Phone Auth 후 자동 생성)
      allow create: if false;

      // 수정: 본인 정보만 (firebaseUid로 확인) 또는 관리자
      allow update: if isSignedIn() && (
        (resource.data.firebaseUid == request.auth.uid) ||
        isAdmin()
      );

      // 삭제: 금지
      allow delete: if false;
    }

    // ============================================
    // 공지사항 (Notices)
    // ============================================
    match /notices/{noticeId} {
      // 읽기: 로그인한 사용자만
      allow read: if isSignedIn();

      // 생성/수정/삭제: 관리자만
      allow create, update, delete: if isAdmin();
    }

    // ============================================
    // 다이렉트 메시지 (Messages)
    // ============================================
    match /messages/{messageId} {
      // 읽기: 발신자, 수신자, 또는 관리자만
      allow read: if isSignedIn() && (
        resource.data.senderId == request.auth.uid ||
        resource.data.receiverId == request.auth.uid ||
        isAdmin()
      );

      // 생성: 로그인한 사용자만 + 필수 필드 검증
      allow create: if isSignedIn() &&
                      request.resource.data.senderId == request.auth.uid &&
                      request.resource.data.receiverId is string &&
                      request.resource.data.conversationId is string &&
                      ((request.resource.data.content is string &&
                        request.resource.data.content.size() > 0) ||
                       (request.resource.data.imageUrl is string &&
                        request.resource.data.imageUrl.size() > 0));

      // 수정: isRead 상태만 변경 가능 (수신자만)
      allow update: if isSignedIn() &&
                      resource.data.receiverId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys()
                      .hasOnly(['isRead']);

      // 삭제: 금지 (메시지는 삭제하지 않음)
      allow delete: if false;
    }

    // ============================================
    // 독서 인증 자료 (Reading Submissions)
    // ============================================
    match /reading_submissions/{submissionId} {
      // 읽기: 로그인한 사용자만
      allow read: if isSignedIn();

      // 생성: 로그인한 사용자만 + 필수 필드 검증
      // 참고: participantId는 Firestore document ID이므로 직접 비교 불가
      // 프론트엔드에서 올바른 participantId 전달 책임
      allow create: if isSignedIn() &&
                      request.resource.data.participantId is string &&
                      request.resource.data.participationCode is string &&
                      request.resource.data.bookTitle is string &&
                      request.resource.data.bookImageUrl is string &&
                      request.resource.data.review is string &&
                      request.resource.data.dailyQuestion is string &&
                      request.resource.data.dailyAnswer is string &&
                      request.resource.data.status == 'approved';

      // 수정: 본인이 작성한 것만 또는 관리자
      // participantId로 participant 문서를 조회하여 firebaseUid 확인
      allow update: if isSignedIn() && (
        (exists(/databases/$(database)/documents/participants/$(resource.data.participantId)) &&
         get(/databases/$(database)/documents/participants/$(resource.data.participantId)).data.firebaseUid == request.auth.uid) ||
        isAdmin()
      );

      // 삭제: 관리자만
      allow delete: if isAdmin();
    }
  }
}
