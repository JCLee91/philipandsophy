# 코드 리뷰: 유저 코호트(기수) 관리 및 전환 프로세스 (Archive)

이 문서는 특정 시점의 코드 리뷰 기록입니다.

## 1. 아키텍처 개요: 멀티 문서 유저 모델 (Multi-Document User Model)
이 시스템은 유저에 대해 **"기수당 하나의 문서(One Document Per Cohort)"** 모델을 사용합니다.
- **구조:** 물리적으로 동일한 유저(전화번호 `phoneNumber`로 식별)라도, 참여하는 기수마다 *새로운* `participant` 문서를 생성합니다.
- **연결:** `firebaseUid` (로그인 ID)는 고정된 마스터 유저 레코드에 귀속되지 않고, **이동 가능(Movable)** 합니다. 즉, 현재 활성화된 기수의 참가자 문서로 "이전"됩니다.

> [!NOTE]
> 이는 매우 독특한 설계 선택입니다. 기수 간 데이터 격리(Data Leakage 방지)는 완벽하지만, 유저의 로그인 세션을 새 기수로 옮기기 위해서는 반드시 엄격한 "마이그레이션" 과정이 필요합니다.

## 2. 핵심 프로세스: 기수 전환 (마이그레이션)
전환 과정은 전적으로 `migrate-uid-to-latest-cohort.ts` 스크립트에 의존합니다.

### 동작 메커니즘
1.  **전화번호 그룹화:** 동일한 전화번호를 공유하는 모든 참가자 문서를 찾습니다.
2.  **타겟 식별:** "최신" 기수를 식별합니다 (`createdAt` 또는 ID 기준).
3.  **UID 이동:**
    -   **새** 참가자 문서에 `firebaseUid: <uid>`를 설정합니다.
    -   **이전** 참가자 문서들의 `firebaseUid`를 `null`로 설정합니다.

### 위험 요소 및 안전 장치
-   **수동 의존성:** 현재 이 과정은 수동 스크립트 실행으로 보입니다. 유저가 새 기수에 가입했더라도 이 스크립트가 실행되지 않으면, 로그인 시 여전히 이전 기수 대시보드가 보입니다.
-   **연결 파괴:** 이전 문서에서 `firebaseUid`를 제거한다는 것은 "Auth -> 과거 데이터"로 가는 직접적인 링크를 끊는 것을 의미합니다. 과거 이력을 추적하려면 반드시 `phoneNumber`를 통해야 합니다.
-   **안전 장치:** 스크립트는 기본적으로 `dry-run`(모의 실행) 모드를 지원하여 안전성을 확보하고 있습니다.

## 3. 로직 분석: `src/lib/firebase/participants.ts`

### `getParticipantByFirebaseUid` (로그인 로직)
이 함수는 시스템의 문지기 역할을 하며, 강력한 **"자가 치유(Self-Healing)"** 로직을 포함하고 있습니다:
1.  **중복 처리:** 만약 동일한 UID를 가진 문서가 여러 개 발견되면(데이터 오염), 자동으로:
    -   경고 로그를 남깁니다.
    -   가장 유력한 후보(활성 기수 > 최신 기수)를 선택합니다.
    -   나머지 문서들의 `firebaseUid`를 **제거(Nuke)** 하여 데이터 상태를 즉시 복구합니다.
    -   *평가: 매우 훌륭한 방어적 프로그래밍입니다.*

2.  **우선순위 로직:**
    -   **1순위:** `isActive: true`인 기수.
    -   **2순위:** ID 숫자가 가장 높은 기수 (최신).
    -   *평가: 마이그레이션이 완벽하지 않더라도, 기수 컬렉션의 `isActive` 플래그만 잘 관리하면 트래픽을 올바른 곳으로 유도할 수 있습니다.*

### `getParticipantByPhoneNumber`
-   동일한 "활성 > 최신" 우선순위를 따릅니다.
-   마이그레이션 스크립트가 올바른 타겟을 식별하는 데 결정적인 역할을 합니다.

## 4. 코드 품질 및 관찰 사항

### 장점
-   **트랜잭션 안전성:** `updateParticipantBookInfo` 함수는 `runTransaction`을 사용하여 동시 업데이트 시에도 데이터 무결성을 보장합니다.
-   **타입 안전성:** TypeScript 인터페이스(`Participant`, `Cohort`)를 일관되게 사용하고 있습니다.
-   **정리 상태:** 사용하지 않는 함수들(`createCohort`, `deleteCohort`)은 명확히 제거되거나 deprecated 표시가 되어 있어 코드베이스가 깔끔합니다.

### 개선 제안 / 권장 사항

1.  **마이그레이션 자동화:**
    -   *현재:* 수동 스크립트 실행.
    -   *제안:* 새 참가자 문서가 생성될 때(`onCreate` 트리거) Cloud Function을 통해 이 로직을 자동 실행하도록 개선. 동일한 전화번호를 가진 유저가 있다면 자동으로 UID를 이동시킵니다.

2.  **마스터 유저 인덱스 (선택 사항):**
    -   현재 유저의 전체 이력을 찾으려면 `phoneNumber`로 쿼리해야 합니다.
    -   규모가 커질 경우, `firebaseUid` -> `[participantId1, participantId2, ...]` 매핑을 관리하는 별도의 `users` 컬렉션 도입을 고려해볼 수 있습니다.

3.  **하드코딩된 로직 주의:**
    -   마이그레이션 스크립트는 `createdAt`을 기준으로 정렬합니다. `createdAt` 데이터의 신뢰성이 중요합니다. `participants.ts`의 ID 기반 정렬(`parseInt(cohortId)`)은 기수 ID가 숫자일 때만 유효합니다. 추후 UUID 등으로 변경 시 이 로직은 깨질 수 있습니다.

## 5. 총평
이 시스템은 **견고하지만 수동적**입니다. 코드는 엣지 케이스(중복, 다중 활성 기수 등)를 자가 치유 로직으로 매우 잘 처리하고 있습니다. 주요 운영 리스크는 기수 오픈 시점과 마이그레이션 스크립트 실행 시점 사이의 타이밍 문제입니다.

**평가:**
-   **로직 무결성:** ⭐⭐⭐⭐⭐ (자가 치유 및 우선순위 로직이 매우 훌륭함)
-   **확장성:** ⭐⭐⭐⭐ (양호하나, 전화번호 그룹화 스캔 비용이 존재)
-   **자동화:** ⭐⭐⭐ (수동 스크립트에 의존)
