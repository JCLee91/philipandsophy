---
title: 오늘의 서재 매칭이 “첫 인증” 화면으로 잘못 표시되는 문제
created: 2025-02-14
tags:
  - today-library
  - matching
  - regression
---

## 증상

- 어제 인증을 하지 못한 참가자가 **오늘 인증을 완료**했을 때,
  - `오늘의 서재` 화면이 기존에 받아 두었던 매칭 프로필을 잠금 상태로 보여 주지 않고
  - “첫 인증을 완료했어요! 🎉” 안내 화면으로 잘못 분기한다.
- 실제로는 이미 매칭 이력이 있음에도 `allFeaturedIds`가 비어 있는 상태가 되며, 프로필북 목록이 비워짐.

## 영향 범위

- “어제 인증 건너뜀 → 오늘 인증” 케이스 전원.
- 프로그램 첫날 새 참가자(진짜 첫 인증)는 기존 로직대로 안내 화면을 받으므로 영향 없음.

## 원인

1. `getMatchingAccessDates` 정책이 “오늘 인증한 날짜만 허용”으로 강화되면서,  
   `allowedMatchingDates` 집합이 더 이상 비어 있지 않게 됨.
2. `findLatestMatchingForParticipant`는 `allowedDates`에 없는 날짜를 모두 건너뛰도록 구현되어 있어,  
   **오늘자 매칭 문서가 아직 생성되지 않은 시간대**에는 과거 매칭도 전부 필터링된다.
3. `matchingLookup`이 `null`이 되면 `allFeaturedIds`가 비게 되고, 그 결과 **첫 인증 전용 안내 화면**이 렌더링된다.

## 해결

- `src/app/app/chat/today-library/page.tsx`에서 접근 허용 범위 내 매칭(`matchingLookupWithinAccess`)과  
  제한 없이 가져온 최신 매칭(`matchingLookup`)을 분리했다.
- 접근 가능한 매칭이 없다면 제한을 풀고 **가장 최근 매칭을 fallback**으로 사용하여 카드 목록을 구성한다.
- 프로필 페이지 내부 스포일러 방지 로직(`filterSubmissionsByDate`)은 그대로 유지해,  
  fallback 매칭도 매칭일 이후 제출물은 자동으로 숨겨진다.

## 재현 및 검증 단계

1. A 참가자가 Day N에서 인증을 완료해 매칭을 받았다고 가정한다.
2. Day N+1 자정 이후 **새벽 2시 이전**에 인증하지 않고 지나간다.
3. Day N+1 오후(매칭 생성 전)에 앱에서 오늘 인증을 완료한다.
4. 오늘의 서재 화면을 열면:
   - **이전 매칭 카드가 그대로 노출되는지** 확인 (잠금 UI 없음).
   - 카드 클릭 시 URL 파라미터에 `matchingDate=N`이 포함되며 프로필 페이지가 열린다.
5. 오후 4시 이후 새 매칭이 들어오면 오늘자 매칭으로 자동 갱신되는지 확인.

## 예방

- 접근 정책(`getMatchingAccessDates`)을 변경하거나 today-library 매칭 로직을 손볼 때는 아래 케이스를 반드시 QA 한다.
  1. 첫 인증 직후 (매칭 없음)
  2. “어제 인증 건너뜀 → 오늘 인증” (fallback 매칭)
  3. 오늘 매칭 생성 직후 (정상 매칭)
- 자동화 가능 시 위 세 케이스를 스모크 테스트 시나리오에 추가한다.
